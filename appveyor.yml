version: '1.0.{build}'
image: Visual Studio 2017
skip_branch_with_pr: true
branches:
  only:
  - dev
clone_depth: 1
init:
  # Good practise, because Windows
  - git config --global core.autocrlf true
before_build:
  # Resote backend solution
  - cmd: cd backend
  - cmd: dotnet restore --verbosity m
  # Resote DataAccumulator solution
  - cmd: cd ../DataAccumulator
  - cmd: dotnet restore --verbosity m
build_script:
  # output will be in ./DataAccumulator/DataAccumulator.WebAPI/bin/Release/netcoreapp2.1/publish/
  - cmd: dotnet publish -c Release
  # output will be in ./backend/Watcher/bin/Release/netcoreapp2.1/publish/
  - cmd: cd ../backend
  - cmd: dotnet publish -c Release
test_script:
 # tests in here
 # Temporarily disabling tests
 # - cmd: cd backend\Watcher.Tests
 # - cmd: dotnet xunit
artifacts:
 - path: '\backend\Watcher\bin\Release\netcoreapp2.1\publish'
   name: api

 - path: '\DataAccumulator\DataAccumulator.WebAPI\bin\Release\netcoreapp2.1\publish'
   name: dataaccumulator
notifications:
  - provider: Slack
    incoming_webhook:
      secure: om6ZaQPG70gvmoGaTQ2IfnTM8LQFROsCT1l23SGjLCVtLIufhCl+gDK1+K4UjfZNLmZJj/bjuNFuiVargaYtl64Ul4IslvGflpz7I6sSqc8=
    on_build_success: false
    on_build_failure: true
    on_build_status_changed: true
    # on_build_status_changed: false
# Deploy backend solution
deploy:
  - provider: WebDeploy
    server:
      secure: nNKKJCMFnMPuP52tFFLA93hteYJTOb3+dU47N/h5uKr6nfXd9bDPUU1ozSZ82gKg/e2+vlAr9F3I2LYInKvdqCHj0xWJcra+uV7Y1bjv1rI=
    website:
      secure: pNUAy/VQRZwI+8al9IOPlT2YIBTfXna6KYCkWiSaEOI=
    username:
      secure: zg+kejsjJ9DT5mEADF94cA==
    password:
      secure: hyncvlOwHaiC5YAl55t0M0K9jBnvX9+ktdBfU84h8qEoz1SS5HNem/JD1ULGSzxgvS0cTwOQK2P9frQEEBpn+w==
    remove_files: true
    app_offline: true
    artifact: api
# Deploy DataAccumulator
  - provider: WebDeploy
    server:
      secure: OHGapbdB9kEq46211ak8MLSCCfr3JRV2m12AuK8LO2MSHf1GLHtfXyL6ibua9+C6q2RihgXCCD/iWl1uFcsQG5AVG4C6Xu1PuVy+QRtgKpu4uChv4bF7H7mCWpo/6PF5Aqf7XNPmGXVYB8DRfuUqMA==
    website:
      secure: TD1RoHd6d+XUOhXRxS+vTbbI/eN1w+0N5ADJ1oxT65Q=
    username:
      secure: ybDMoXH+l+Q6bTLhNAPYxMwkNV9mfugViALrzuvSyBs=
    password:
      secure: 1TnXKrBoB5GgmmWIzmlt5LraKCLr8t460Hp2eqJdZtSk+m327ur4mh9qFUr0Ei4do/BOJ4mBtar0d+3npHF9xw==
    remove_files: true
    app_offline: true
    artifact: dataaccumulator
